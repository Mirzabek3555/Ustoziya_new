{% extends 'base.html' %}

{% block title %}AI yordamida Test Yaratish - Ustoziya Platformasi{% endblock %}
{% block page_title %}AI yordamida Test Yaratish{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-robot me-2"></i>
                    AI yordamida Test Yaratish
                </h5>
            </div>
            <div class="card-body">
                <!-- AI yordamida test yaratish -->
                <div class="mb-4">
                    <h6 class="text-info mb-3">
                        <i class="fas fa-magic me-2"></i>
                        AI yordamida test yaratish
                    </h6>
                    
                    <form id="aiTestForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="subject" class="form-label">Fan *</label>
                                <select class="form-select" id="subject" name="subject" required>
                                    <option value="">Fan tanlang...</option>
                                    <option value="mathematics">Matematika</option>
                                    <option value="physics">Fizika</option>
                                    <option value="chemistry">Kimyo</option>
                                    <option value="biology">Biologiya</option>
                                    <option value="geography">Geografiya</option>
                                    <option value="history">Tarix</option>
                                    <option value="literature">Adabiyot</option>
                                    <option value="language">Til va adabiyot</option>
                                    <option value="english">Ingliz tili</option>
                                    <option value="russian">Rus tili</option>
                                    <option value="computer_science">Informatika</option>
                                    <option value="art">San'at</option>
                                    <option value="physical_education">Jismoniy tarbiya</option>
                                    <option value="other">Boshqa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="grade_level" class="form-label">Sinf Darajasi *</label>
                                <input type="text" class="form-control" id="grade_level" name="grade_level" placeholder="Masalan: 7-sinf" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="difficulty" class="form-label">Qiyinlik Darajasi *</label>
                                <select class="form-select" id="difficulty" name="difficulty" required>
                                    <option value="">Qiyinlik tanlang...</option>
                                    <option value="easy">Oson</option>
                                    <option value="medium">O'rta</option>
                                    <option value="hard">Qiyin</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="category" class="form-label">Kategoriya *</label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Kategoriya tanlang...</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="aiNumQuestions" class="form-label">Savollar soni</label>
                                <input type="number" class="form-control" id="aiNumQuestions" value="5" min="1" max="20">
                        </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="aiTopic" class="form-label">Mavzu (ixtiyoriy)</label>
                                <input type="text" class="form-control" id="aiTopic" placeholder="Masalan: Algebra, Geometriya">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="time_limit" class="form-label">Vaqt Chegarasi (daqiqa)</label>
                                <input type="number" class="form-control" id="time_limit" name="time_limit" value="60" min="1" max="300">
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" class="btn btn-info btn-lg" id="generateAiTest">
                                <i class="fas fa-magic me-2"></i>
                                AI yordamida test yaratish
                            </button>
                        </div>
                    </form>
                        </div>
                        
                <!-- Natija ko'rsatish -->
                <div id="testResult" class="mb-4" style="display: none;">
                    <h6 class="text-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        Test muvaffaqiyatli yaratildi!
                    </h6>
                    <div class="alert alert-success">
                        <p id="resultMessage"></p>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success me-2" id="exportToWord">
                                <i class="fas fa-file-word me-2"></i>
                                Word formatida yuklab olish
                            </button>
                            <button type="button" class="btn btn-primary" id="viewTest">
                                <i class="fas fa-eye me-2"></i>
                                Testni ko'rish
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let generatedTest = null;
    
    // AI test generation
    document.getElementById('generateAiTest').addEventListener('click', function() {
        const subject = document.getElementById('subject').value;
        const gradeLevel = document.getElementById('grade_level').value;
        const difficulty = document.getElementById('difficulty').value;
        const category = document.getElementById('category').value;
        const numQuestions = document.getElementById('aiNumQuestions').value;
        const topic = document.getElementById('aiTopic').value;
        const timeLimit = document.getElementById('time_limit').value;
        
        if (!subject || !gradeLevel || !difficulty || !category) {
            alert('Iltimos, barcha majburiy maydonlarni to\'ldiring');
            return;
        }
        
        const button = this;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>AI ishlayapti...';
        button.disabled = true;
        
        const data = {
            subject: subject,
            grade_level: gradeLevel,
            difficulty: difficulty,
            category_id: category,
            num_questions: parseInt(numQuestions),
            topic: topic,
            time_limit: parseInt(timeLimit)
        };
        
        fetch('/api/tests/generate-ai/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                generatedTest = data.test;
                document.getElementById('resultMessage').textContent = 
                    `AI yordamida test muvaffaqiyatli yaratildi! ${data.questions_count} ta savol qo'shildi.`;
                document.getElementById('testResult').style.display = 'block';
                document.getElementById('aiTestForm').style.display = 'none';
            } else {
                alert('Xatolik: ' + (data.error || 'Noma\'lum xatolik'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Server bilan aloqa xatoligi');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    });
    
    // Word export
    document.getElementById('exportToWord').addEventListener('click', function() {
        if (!generatedTest) {
            alert('Avval test yaratish kerak');
            return;
        }
        
        // Word export uchun ma'lumotlarni yuborish
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/tests/export-word/';
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const testId = document.createElement('input');
        testId.type = 'hidden';
        testId.name = 'test_id';
        testId.value = generatedTest.id;
        
        form.appendChild(csrfToken);
        form.appendChild(testId);
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    });
    
    // Test ko'rish
    document.getElementById('viewTest').addEventListener('click', function() {
        if (!generatedTest) {
            alert('Avval test yaratish kerak');
            return;
        }
        
        window.location.href = `/tests/${generatedTest.id}/`;
    });
});
</script>
{% endblock %}