{% extends 'base.html' %}

{% block title %}Testlar - Ustoziya Platformasi{% endblock %}
{% block page_title %}Testlar{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Barcha Testlar
                </h5>
                <div>
                    <a href="{% url 'test_create' %}" class="btn btn-primary me-2">
                        <i class="fas fa-plus me-2"></i>
                        Yangi Test
                    </a>
                    <a href="{% url 'test_ocr_upload' %}" class="btn btn-info">
                        <i class="fas fa-camera me-2"></i>
                        OCR Tahlil
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Form -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="filterGrade" onchange="filterTests()">
                            <option value="">Barcha sinflar</option>
                            <option value="1-sinf">1-sinf</option>
                            <option value="2-sinf">2-sinf</option>
                            <option value="3-sinf">3-sinf</option>
                            <option value="4-sinf">4-sinf</option>
                            <option value="5-sinf">5-sinf</option>
                            <option value="6-sinf">6-sinf</option>
                            <option value="7-sinf">7-sinf</option>
                            <option value="8-sinf">8-sinf</option>
                            <option value="9-sinf">9-sinf</option>
                            <option value="10-sinf">10-sinf</option>
                            <option value="11-sinf">11-sinf</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterSubject" onchange="filterTests()">
                            <option value="">Barcha fanlar</option>
                            <option value="mathematics">Matematika</option>
                            <option value="physics">Fizika</option>
                            <option value="chemistry">Kimyo</option>
                            <option value="biology">Biologiya</option>
                            <option value="geography">Geografiya</option>
                            <option value="history">Tarix</option>
                            <option value="literature">Adabiyot</option>
                            <option value="language">Til va adabiyot</option>
                            <option value="english">Ingliz tili</option>
                            <option value="russian">Rus tili</option>
                            <option value="computer_science">Informatika</option>
                            <option value="art">San'at</option>
                            <option value="physical_education">Jismoniy tarbiya</option>
                            <option value="other">Boshqa</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterDifficulty" onchange="filterTests()">
                            <option value="">Barcha qiyinliklar</option>
                            <option value="easy">Oson</option>
                            <option value="medium">O'rta</option>
                            <option value="hard">Qiyin</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="Qidirish..." onkeyup="filterTests()">
                    </div>
                </div>

                <!-- Tests Grid -->
                <div id="testsGrid">
                    {% if tests %}
                        <div class="row">
                            {% for test in tests %}
                            <div class="col-md-6 col-lg-4 mb-4 test-card" 
                                 data-grade="{{ test.grade_level|lower }}" 
                                 data-subject="{{ test.subject|lower }}" 
                                 data-difficulty="{{ test.difficulty|lower }}"
                                 data-title="{{ test.title|lower }}"
                                 data-description="{{ test.description|lower }}">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ test.title }}</h6>
                                        <p class="card-text text-muted">{{ test.description|truncatewords:20 }}</p>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-success">{{ test.get_difficulty_display }}</span>
                                            <small class="text-muted">{{ test.total_questions }} savol</small>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-info">{{ test.grade_level }}</span>
                                            <small class="text-muted">{{ test.time_limit }} daqiqa</small>
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-secondary">{{ test.subject }}</span>
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-flex justify-content-between">
                                            <small class="text-muted">{{ test.author.get_full_name }}</small>
<<<<<<< HEAD
                                            <a href="{% url 'test_detail' test.id %}" class="btn btn-sm btn-outline-primary" target="_blank">Ko'rish</a>
=======
                                            <div>
                                                <a href="{% url 'test_results' test.id %}" class="btn btn-sm btn-outline-success me-1">
                                                    <i class="fas fa-chart-bar"></i>
                                                </a>
                                                <a href="#" class="btn btn-sm btn-outline-primary">Ko'rish</a>
                                            </div>
>>>>>>> 0c017e790f84d71572a687d1104cb354dcdea57b
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Hozircha testlar yo'q</h5>
                        <p class="text-muted">Birinchi testni yarating</p>
                        <a href="{% url 'test_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Yangi Test
                        </a>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function filterTests() {
    const gradeFilter = document.getElementById('filterGrade').value.toLowerCase();
    const subjectFilter = document.getElementById('filterSubject').value.toLowerCase();
    const difficultyFilter = document.getElementById('filterDifficulty').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    console.log('Filter values:', { gradeFilter, subjectFilter, difficultyFilter, searchInput });
    
    const testCards = document.querySelectorAll('.test-card');
    let visibleCount = 0;
    
    testCards.forEach(card => {
        const grade = card.getAttribute('data-grade').toLowerCase().trim();
        const subject = card.getAttribute('data-subject').toLowerCase().trim();
        const difficulty = card.getAttribute('data-difficulty').toLowerCase().trim();
        const title = card.getAttribute('data-title');
        const description = card.getAttribute('data-description');
        
        let show = true;
        
        // Grade filter - more flexible matching
        if (gradeFilter) {
            // Try exact match first
            if (grade !== gradeFilter) {
                // Try partial match (e.g., "9" matches "9-sinf")
                const gradeNumber = gradeFilter.replace('-sinf', '');
                const cardGradeNumber = grade.replace('-sinf', '');
                console.log(`Grade comparison: "${gradeNumber}" vs "${cardGradeNumber}"`);
                if (gradeNumber !== cardGradeNumber) {
                    show = false;
                }
            }
        }
        
        // Subject filter
        if (subjectFilter && subject !== subjectFilter) {
            show = false;
        }
        
        // Difficulty filter
        if (difficultyFilter && difficulty !== difficultyFilter) {
            show = false;
        }
        
        // Search filter
        if (searchInput && !title.includes(searchInput) && !description.includes(searchInput)) {
            show = false;
        }
        
        if (show) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show message if no tests found
    let noResultsMsg = document.getElementById('noResultsMsg');
    if (visibleCount === 0) {
        if (!noResultsMsg) {
            noResultsMsg = document.createElement('div');
            noResultsMsg.id = 'noResultsMsg';
            noResultsMsg.className = 'text-center py-5';
            noResultsMsg.innerHTML = `
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Hech qanday test topilmadi</h5>
                <p class="text-muted">Filtrlarni o'zgartiring yoki qidiruv so'zini o'zgartiring</p>
            `;
            document.getElementById('testsGrid').appendChild(noResultsMsg);
        }
        noResultsMsg.style.display = 'block';
    } else {
        if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
}

// Add clear filters button
document.addEventListener('DOMContentLoaded', function() {
    const filterRow = document.querySelector('.row.mb-4');
    const clearButton = document.createElement('div');
    clearButton.className = 'col-12 mt-2';
    clearButton.innerHTML = `
        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
            <i class="fas fa-times me-2"></i>
            Filtrlarni tozalash
        </button>
        <button class="btn btn-outline-info btn-sm ms-2" onclick="debugFilters()">
            <i class="fas fa-bug me-2"></i>
            Debug
        </button>
    `;
    filterRow.appendChild(clearButton);
});

function clearFilters() {
    document.getElementById('filterGrade').value = '';
    document.getElementById('filterSubject').value = '';
    document.getElementById('filterDifficulty').value = '';
    document.getElementById('searchInput').value = '';
    filterTests();
}

function debugFilters() {
    console.log('=== DEBUG FILTERS ===');
    const testCards = document.querySelectorAll('.test-card');
    console.log('Total test cards found:', testCards.length);
    
    testCards.forEach((card, index) => {
        const grade = card.getAttribute('data-grade');
        const subject = card.getAttribute('data-subject');
        const difficulty = card.getAttribute('data-difficulty');
        const title = card.getAttribute('data-title');
        
        console.log(`Card ${index + 1}:`, {
            grade: `"${grade}"`,
            subject: `"${subject}"`,
            difficulty: `"${difficulty}"`,
            title: title.substring(0, 50)
        });
    });
    
    console.log('Current filter values:', {
        grade: document.getElementById('filterGrade').value,
        subject: document.getElementById('filterSubject').value,
        difficulty: document.getElementById('filterDifficulty').value,
        search: document.getElementById('searchInput').value
    });
    console.log('=== END DEBUG ===');
}
</script>

<style>
.test-card {
    transition: all 0.3s ease;
}

.test-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.form-select, .form-control {
    border-radius: 8px;
    border: 1px solid #ddd;
    transition: border-color 0.3s ease;
}

.form-select:focus, .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.badge {
    font-size: 0.75rem;
    padding: 0.4em 0.6em;
}
</style>
{% endblock %}
